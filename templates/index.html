<!DOCTYPE html>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    </head>
    <body>
        <div class="row">
            <!-- Front Yard -->
            <div class="col-4">
                <div class="card full-height-panel panel" style="background-color:rgb(105, 174, 105);">
                    <div class="card-header">
                        Front Yard
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <form method="post" action="/add-plant">
                                <input type="hidden" name="position" value="0"> <!-- 0 for Front Yard, 1 for ISL, etc. -->
                                <input type="text" name="plant_name" class="form-control" placeholder="Plant name">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Add Plant</button>
                                </div>
                            </form>
                        </div>
                        <table id="frontyard-plant-table" class="table plant-table">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Next Water</th>
                                    <th scope="col">Frequency</th>
                                    <th scope="col">Events</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plant in organized_data[0] %} <!-- '0' for Front Yard, '1' for ISL, etc. -->
                                <tr data-plant-id={{ plant.id }}>
                                    <td>{{ plant.name }}</td>
                                    <td>{{ plant.today_water }}</td>
                                    <td>{{ plant.water_schedule }} days</td>
                                    <td>
                                        {% if plant.food_event %}
                                        <span>Food!</span><br>
                                        {% endif %}
                                        {% if plant.repotting_event %}
                                        <span>Check pot!</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inside -->
            <div class="col-4">
                <!-- Sunlight -->
                <div class="card half-height-panel panel" style="background-color:rgb(255, 255, 124);">
                    <div class="card-header">
                        Inside (Sunlight)
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <form method="post" action="/add-plant">
                                <input type="hidden" name="position" value="1"> <!-- 0 for Front Yard, 1 for ISL, etc. -->
                                <input type="text" name="plant_name" class="form-control" placeholder="Plant name">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Add Plant</button>
                                </div>
                            </form>
                        </div>
                        <table id="isl-plant-table" class="table plant-table">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Next Water</th>
                                    <th scope="col">Frequency</th>
                                    <th scope="col">Events</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plant in organized_data[1] %} <!-- '0' for Front Yard, '1' for ISL, etc. -->
                                <tr data-plant-id={{ plant.id }}>
                                    <td>{{ plant.name }}</td>
                                    <td>{{ plant.today_water }}</td>
                                    <td>{{ plant.water_schedule }} days</td>
                                    <td>
                                        {% if plant.food_event %}
                                        <span>Food!</span><br>
                                        {% endif %}
                                        {% if plant.repotting_event %}
                                        <span>Check pot!</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Low-light -->
                <div class="card half-height-panel panel" style="background-color:rgb(200, 200, 200);">
                    <div class="card-header">
                        Inside (Low-light)
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <form method="post" action="/add-plant">
                                <input type="hidden" name="position" value="2"> <!-- 0 for Front Yard, 1 for ISL, etc. -->
                                <input type="text" name="plant_name" class="form-control" placeholder="Plant name">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Add Plant</button>
                                </div>
                            </form>
                        </div>
                        <table id="ill-plant-table" class="table plant-table">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Next Water</th>
                                    <th scope="col">Frequency</th>
                                    <th scope="col">Events</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plant in organized_data[2] %} <!-- '0' for Front Yard, '1' for ISL, etc. -->
                                <tr data-plant-id={{ plant.id }}>
                                    <td>{{ plant.name }}</td>
                                    <td>{{ plant.today_water }}</td>
                                    <td>{{ plant.water_schedule }} days</td>
                                    <td>
                                        {% if plant.food_event %}
                                        <span>Food!</span><br>
                                        {% endif %}
                                        {% if plant.repotting_event %}
                                        <span>Check pot!</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Back Yard -->
            <div class="col-4">
                <div class="card full-height-panel panel" style="background-color:rgb(105, 174, 105);">
                    <div class="card-header">
                        Back Yard
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <form method="post" action="/add-plant">
                                <input type="hidden" name="position" value="3"> <!-- 0 for Front Yard, 1 for ISL, etc. -->
                                <input type="text" name="plant_name" class="form-control" placeholder="Plant name">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Add Plant</button>
                                </div>
                            </form>
                        </div>
                        <table id="backyard-plant-table" class="table plant-table">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Next Water</th>
                                    <th scope="col">Frequency</th>
                                    <th scope="col">Events</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plant in organized_data[3] %} <!-- '0' for Front Yard, '1' for ISL, etc. -->
                                <tr data-plant-id={{ plant.id }}>
                                    <td>{{ plant.name }}</td>
                                    <td>{{ plant.today_water }}</td>
                                    <td>{{ plant.water_schedule }} days</td>
                                    <td>
                                        {% if plant.food_event %}
                                        <span>Food!</span><br>
                                        {% endif %}
                                        {% if plant.repotting_event %}
                                        <span>Check pot!</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!--<div class="modal fade" id="plantSelectionModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Select the Correct Plant</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="modalBody">-->
                        <!-- Plant buttons will be added here by JavaScript -->
                    <!--</div>
                </div>
            </div>
        </div>-->
    </body>
</html>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let tables = document.querySelectorAll('.plant-table');
        tables.forEach(table => {
            table.addEventListener('click', function (event) {
                let target = event.target;
                let row = target.closest('tr'); // Get clicked row...
                if (!row) return; // Exit if no row was clicked

                let plantId = row.getAttribute('data-plant-id'); // Get plant id from organized_data
                if (!plantId) return;

                let plantName = row.cells[0].innerText; // Name is in the first cell
                let plantTodayWater = row.cells[1].innerText; // Today's water is in the second cell
                let plantWaterSchedule = row.cells[2].innerText; // Water schedule is in the third cell
                let plantEvents = row.cells[3].innerText; // Events are in the fourth cell

                if (row && row.classList.contains('expanded')) {
                    row.classList.remove('expanded');
                    // Reset to original row state
                    row.innerHTML = `
                    <td>${plantName}</td>
                    <td>${plantTodayWater}</td>
                    <td>${plantWaterSchedule}</td>
                    <td>${plantEvents}</td>
                `;
                } else if (row && !row.classList.contains('expanded') && !table.querySelector('.expanded')) {
                    row.classList.add('expanded');
                    fetch('/get-plant-details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ plantId: plantId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Create a new row for the expanded content
                            // Create the first new row for part of the expanded content
                            let expandedRow1 = table.insertRow(row.rowIndex + 1);
                            for (let i = 0; i < 4; i++) { // Assuming you want 4 cells in the first expanded row
                                let cell = expandedRow1.insertCell(i);
                                switch (i) {
                                    case 0: cell.innerHTML = `Food: ${data.food_schedule} months`; break;
                                    case 1: cell.innerHTML = `Repot: ${data.repotting_schedule} months`; break;
                                    case 2: cell.innerHTML = `Date: ${data.date_added}`; break;
                                    case 3: cell.innerHTML = `Position: ${data.position}`; break;
                                }
                            }
                            // Create the second new row for the rest of the expanded content
                            let expandedRow2 = table.insertRow(row.rowIndex + 2);
                            for (let i = 0; i < 4; i++) { // Assuming you want 4 cells in the second expanded row
                                let cell = expandedRow2.insertCell(i);
                                switch (i) {
                                    case 0: cell.appendChild(createButton('Confirm', 'btn-primary confirm-edit')); break;
                                    case 1: cell.appendChild(createButton('Delete', 'btn-danger delete-row')); break;
                                }
                            }
                        })
                        .catch(error => console.error('Error:', error));

                    // Make Frequency, Position cells editable
                    let freqCell = row.cells[2];
                    let posCell; // Assuming position is in one of the cells in expandedRow1
                    if (expandedRow1 && expandedRow1.cells[3]) {
                        posCell = expandedRow1.cells[3];
                    }
                    if (freqCell) {
                        freqCell.setAttribute('contenteditable', 'true');
                        // Add click event listener to each cell
                        freqCell.addEventListener('click', function (event) {
                            event.stopPropagation();

                            let input = document.createElement('input');
                            input.type = 'number';
                            input.value = freqCell.textContent.replace(/\D/g, ''); // Strip non-digit characters
                            freqCell.innerHTML = '';
                            freqCell.appendChild(input);
                            input.focus();

                            input.addEventListener('blur', function () {
                                freqCell.textContent = input.value + ' days'; // Update cell text when input loses focus
                            });
                        });
                    }
                    if (posCell) {
                        posCell.setAttribute('contenteditable', 'true');
                        posCell.addEventListener('click', function (event) {
                            event.stopPropagation();

                            let input = document.createElement('input');
                            input.type = 'number';
                            input.value = posCell.textContent.replace(/\D/g, ''); // Strip non-digit characters
                            posCell.innerHTML = '';
                            posCell.appendChild(input);
                            input.focus();
                        });
                    }

                    // Confirm Button:
                    // Append Confirm and Delete buttons if they exist
                    if (expandedRow2 && expandedRow2.cells[0]) {
                        let confirmButtonCell = expandedRow2.cells[0];
                        confirmButtonCell.appendChild(createButton('Confirm', 'btn-primary confirm-edit', function () {
                            let updatedFrequency = freqCell.innerText;
                            let updatedPosition = posCell.innerText;
                            updatePlantData(plantId, updatedFrequency, updatedPosition);
                        }));
                        let deleteButtonCell = expandedRow2.cells[1];
                        deleteButtonCell.appendChild(createButton('Delete', 'btn-danger delete-row', function () {
                            deletePlant(plantId, row)
                        }));
                    }
                }
            });
        })

        function createButton(text, className, onClick) {
            let button = document.createElement('button');
            button.textContent = text;
            button.className = className;
            button.addEventListener('click', onClick);
            return button;
        }

        function updatePlantData(plantId, frequency, position) {
            // Send AJAX request to Flask to update the data
            fetch('/update-plant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: plantId, frequency: frequency, position: position })
            })
                .then(response => response.json())
                .then(data => {
                    // Handle response here (e.g., show a success message)
                    console.log(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function deletePlant(plantId, row) {
            // Send AJAX request to Flask to delete the data
            fetch('/delete-plant', {
                // ... AJAX request logic
            })
                .then(response => response.json())
                .then(data => {
                    // Remove the row from the table or handle accordingly
                    row.remove();
                })
                .catch(error => console.error('Error:', error));
        }
    });
    // Add an event listener to the document to collapse expanded rows when clicking outside
    document.addEventListener('click', function (event) {
        let expandedRow = table.querySelector('.expanded + tr'); // Selects the row immediately following an expanded row
        let expanded = table.querySelector('.expanded');
        if (expandedRow && expanded && !expanded.contains(event.target)) {
            expanded.classList.remove('expanded');
            expandedRow.remove(); // Remove the expanded content row
        }
    }, true);
</script>
